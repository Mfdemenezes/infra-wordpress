name: ğŸ—‘ï¸ WordPress Terraform Destroy

on:
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "DESTROY" to confirm WordPress infrastructure destruction'
        required: true
        type: string
      environment:
        description: 'Environment to destroy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      force_destroy:
        description: 'Force destroy (use with caution)'
        required: false
        default: false
        type: boolean

jobs:
  destroy:
    name: ğŸ—‘ï¸ WordPress Terraform Destroy
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment }}
    
    steps:
      - name: âœ… Validate Confirmation
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "DESTROY" ]; then
            echo "âŒ Destruction cancelled. You must type 'DESTROY' to confirm."
            echo "You typed: '${{ github.event.inputs.confirmation }}'"
            exit 1
          fi
          echo "âœ… WordPress infrastructure destruction confirmed."

      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: ğŸ› ï¸ Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.5

      - name: ğŸš€ Terraform Init
        run: terraform init

      - name: ğŸ“‹ Terraform Plan Destroy
        run: |
          echo "Planning WordPress infrastructure destruction..."
          terraform plan -destroy -out=destroy-plan
          echo "ğŸ“‹ Destruction plan created. Review the plan above."

      - name: ğŸ” Show Destruction Plan
        run: |
          echo "ğŸ” WordPress resources to be destroyed:"
          terraform show destroy-plan

      - name: âš ï¸ WordPress Data Warning
        run: |
          echo "âš ï¸  WARNING: This will permanently destroy your WordPress infrastructure!"
          echo ""
          echo "ğŸ—‚ï¸  Data that will be LOST:"
          echo "   - WordPress files and uploads"
          echo "   - MySQL database and all posts/pages"
          echo "   - Docker volumes with persistent data"
          echo "   - ALB and networking configuration"
          echo ""
          echo "ğŸ’¾ Make sure you have backups if needed!"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Force destroy: ${{ github.event.inputs.force_destroy }}"

      - name: â³ Wait for Final Confirmation
        run: |
          echo "âš ï¸  FINAL WARNING: WordPress infrastructure will be destroyed!"
          echo "Proceeding in 15 seconds..."
          sleep 15

      - name: ğŸ”¥ Terraform Destroy
        run: |
          if [ "${{ github.event.inputs.force_destroy }}" == "true" ]; then
            echo "ğŸ”¥ Force destroying WordPress infrastructure..."
            terraform destroy -auto-approve
          else
            echo "ğŸ—‘ï¸  Destroying WordPress infrastructure using plan..."
            terraform apply destroy-plan
          fi

      - name: âœ… Verify WordPress Destruction
        run: |
          echo "ğŸ” Verifying WordPress infrastructure destruction..."
          if terraform state list 2>/dev/null | grep -q .; then
            echo "âš ï¸  Warning: Some WordPress resources may still exist in state"
            terraform state list
          else
            echo "âœ… All WordPress resources successfully destroyed"
          fi

      - name: ğŸ§¹ Cleanup State (Optional)
        if: github.event.inputs.force_destroy == 'true'
        run: |
          echo "ğŸ§¹ Cleaning up WordPress Terraform state..."
          # Uncomment the next line if you want to remove the state file entirely
          # terraform state rm $(terraform state list) || true

      - name: ğŸ“‹ Post-Destruction Summary
        run: |
          echo "ğŸ“‹ WordPress Destruction Summary:"
          echo "âœ… EC2 instances terminated"
          echo "âœ… ALB and target groups removed"
          echo "âœ… VPC and networking resources cleaned up"
          echo "âœ… Security groups deleted"
          echo "âœ… S3 state bucket unchanged (contains state history)"
          echo ""
          echo "ğŸ¯ To redeploy WordPress, run the deploy workflow again"
